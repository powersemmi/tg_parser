# Crawler Service Documentation

## Обзор

Сервис Crawler предназначен для сбора сообщений из каналов Telegram с использованием асинхронного подхода и управления ресурсами через NATS JetStream.

## Архитектура

### Основные компоненты

1. **FastStream Application** (`app.py`) - Главное приложение с обработчиками событий
2. **Resource Manager** - Управление сессиями Telegram через NATS KV
3. **Connection Manager** - Управление подключениями к Telegram API
4. **Parser Module** - Бизнес-логика сбора и обработки сообщений
5. **Database Layer** - Работа с PostgreSQL и схемами данных

### Диаграммы

- [Архитектура сервиса](./architecture.puml)
- [Последовательность сбора сообщений](./message_collection_sequence.puml)
- [Управление ресурсами](./resource_management.puml)
- [Классы парсера](./parser_class_diagram.puml)
- [Жизненный цикл сессии](./session_lifecycle.puml)

## Ключевые возможности

### 1. Управление ресурсами
- Распределенное управление сессиями Telegram через NATS KV
- Автоматическое обновление TTL для активных сессий
- Обработка событий изменения состояния ресурсов

### 2. Сбор сообщений
- Асинхронный сбор сообщений из каналов Telegram
- Обработка ошибок ограничения скорости (FloodWaitError)
- Извлечение метаданных сообщений (реакции, медиа, статистика)

### 3. Управление подключениями
- Поддержка прокси-серверов
- Автоматическое переподключение при ошибках
- Эксклюзивный доступ к клиенту через блокировки

## Модели данных

### MessageDict
Основная структура для представления сообщения:
- `message_id` - ID сообщения
- `entity_id` - ID канала/чата
- `sender_id` - ID отправителя
- `date` - Дата отправки
- `message` - Текст сообщения
- `reactions` - Список реакций
- `views` - Количество просмотров
- `forwards` - Количество пересылок
- `media_type` - Тип медиа-контента

### TelegramMessageMetadata
Метаданные коллекции сообщений:
- `from_message_id` - ID первого сообщения
- `to_message_id` - ID последнего сообщения
- `from_datetime` - Время первого сообщения
- `to_datetime` - Время последнего сообщения
- `count` - Количество сообщений

## Обработка ошибок

1. **FloodWaitError** - Сохранение частичных данных при ограничении скорости
2. **Connection errors** - Автоматическое переподключение с экспоненциальной задержкой
3. **Resource conflicts** - Обработка конфликтов блокировок через NATS KV

## Конфигурация

Сервис настраивается через переменные окружения:
- Параметры подключения к PostgreSQL
- Настройки NATS JetStream
- Конфигурация Telegram API
- Параметры прокси-серверов

## Безопасность

- Все сессии Telegram хранятся в зашифрованном виде в базе данных
- Поддержка прокси-серверов для обхода блокировок
- Ротация сессий для предотвращения блокировок аккаунтов